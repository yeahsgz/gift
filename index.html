<!DOCTYPE html>
<html>
<head lang="zh-Hans">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="applicable-device" content="mobile">
    <title>摇出你的新年礼物</title>
    <meta name="format-detection" content="telephone=no">
    <meta name="wap-font-scale" content="no">
    <style>
        *{
            margin  :0;
            padding :0;
        }

        .gift-logo-wrap{
            margin      :20px auto;
            width       :280px;
            height      :280px;
            will-change :transform;
        }

        @keyframes rotate{
            from{
                transform :rotate(0deg);
            }
            to{
                transform :rotate(360deg);
            }
        }

        .rotate{
            animation :rotate 2s linear infinite;
        }

        .gift-logo{
            display :block;
            width   :100%;
            height  :100%;
        }

        .text-align-c{
            text-align :center;
        }

        .font-size36{
            font-size :28px;
        }

        .font-size32{
            font-size :24px;
        }
    </style>
</head>
<body>

<div class="">
    <div class="gift-logo-wrap">
        <img class="gift-logo j-gift-logo" src="http://iph.href.lu/400x400" alt=""/>
    </div>
    <div class="font-size36 text-align-c">
        晃动屏幕
    </div>
    <div class="font-size32 text-align-c">领取我的专属礼物</div>
    <div class="j-show-result"></div>
</div>
<script src="./js/jq.js"></script>
<script>
    $(document).ready(function () {

        var debounce = function (onStartCb, onEndCb, delay) {
            var _timer;
            var startCbStatus = false;
            return function () {
                var ctx = this;
                var args = arguments;

                if (!startCbStatus) {
                    startCbStatus = true;
                    onStartCb.apply(ctx, args);
                }

                clearTimeout(_timer);
                _timer = setTimeout(function () {
                    onEndCb.apply(ctx, args)
                }, delay || 0);
            }
        };

        //摇一摇开始时的回调函数
        var bindDeviceMotionStart = function (eventData) {
            deviceMotionHandler(eventData, function () {
                $('.j-gift-logo').addClass('rotate');
            });
        };

        //摇一摇结束后的回调函数
        var bindDeviceMotionEnd = function (eventData) {
            deviceMotionHandler(eventData, function () {
                $('.j-show-result').append(JSON.stringify(localGift.giftInfo));
            });
        };


        if (window.DeviceMotionEvent) {
            window.addEventListener('devicemotion', debounce(bindDeviceMotionStart, bindDeviceMotionEnd, 100), false);
        } else {
            alert('你的设备不支持摇一摇');
        }


        var SHAKE_THRESHOLD = 4000;
        var last_update = 0;
        var x, y, z, last_x = 0, last_y = 0, last_z = 0;

        function deviceMotionHandler(eventData, cb) {
            var acceleration = eventData.accelerationIncludingGravity;
            var curTime = new Date().getTime();
            if ((curTime - last_update) > 10) {
                var diffTime = curTime - last_update;
                last_update = curTime;
                x = acceleration.x;
                y = acceleration.y;
                z = acceleration.z;
                var speed = Math.abs(x + y + z - last_x - last_y - last_z) / diffTime * 10000;
                if (speed > SHAKE_THRESHOLD) {
                    cb();
                }
                last_x = x;
                last_y = y;
                last_z = z;
            }
        }

        var localGift = {
            giftInfo: null,
            init: function () {
                this.getGift();
            },
            getGift: function () {
                try {
                    this.giftInfo = JSON.parse(localStorage.getItem('ownGift'));
                } catch (e) {
                    console.log('你的设备不支持localStorage', e);
                }
                this.giftInfo || this.getRandomGift();
            },
            setGift: function (data) {
                try {
                    localStorage.setItem('ownGift', JSON.stringify(data));
                } catch (e) {
                    console.log('你的设备不支持localStorage', e);
                }
            },
            getRandomGift: function () {
                var that = this;
                $.getJSON('./data/giftArr.json', function (data) {
                    var randomIndex = Math.floor(Math.random() * data.length);
                    that.giftInfo = data[randomIndex];
                    that.setGift(that.giftInfo);
                });
            }
        };
        localGift.init();

    })

</script>
</body>
</html>